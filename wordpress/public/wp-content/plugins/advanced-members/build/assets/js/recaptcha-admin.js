(()=>{var e,i;e=jQuery,i={timer:null,delay:200,xhr:null,fields:null,cache:null,currentSiteKey:null,currentSecretKey:null,currentValidated:null,spinner:e("<span>").addClass("acf-spinner"),strings:amemReCaptchaAdmin.strings,formDisabled:!1,init:function(){"undefined"!=typeof acf&&e("#amem-recaptcha-site-key").length&&(this.fields={version:acf.getField(e("#amem-recaptcha-version")),type:acf.getField(e("#amem-recaptcha-type")),size:acf.getField(e("#amem-recatpcha-size")),siteKey:acf.getField(e("#amem-recaptcha-site-key")),secretKey:acf.getField(e("#amem-recaptcha-secret-key")),keysStatus:acf.getField(e("#amem-recaptcha-key-verified")),save:e(".acf-headerbar-field-editor button.acf-publish")},"object"==typeof this.fields.version&&("v3_ent"==this.fields.version.val()?this.verifyEnt():this.verifyGen(),this.fields.siteKey.$el.find(".acf-input-wrap").css({display:"flex","align-items":"center"}),this.fields.secretKey.$el.find(".acf-input-wrap").css({display:"flex","align-items":"center"}),this.currentSiteKey=this.fields.siteKey.val().trim(),this.currentSecretKey=this.fields.secretKey.val().trim(),this.currentValidated=this.fields.keysStatus.val().trim(),this.addEventListeners()))},beforeValidation:function(){this.spinner.clone().appendTo(i.fields.siteKey.$el.find(".acf-input-wrap")).css({display:"inline-block","margin-left":"10px"}),this.spinner.clone().appendTo(i.fields.secretKey.$el.find(".acf-input-wrap")).css({display:"inline-block","margin-left":"10px"})},afterValidation:function(){this.fields.siteKey.$el.find(".acf-spinner").remove(),this.fields.secretKey.$el.find(".acf-spinner").remove(),this.xhr=null},addEventListeners:function(t){e("#post").on("keyup keypress",(function(e){return!i.formDisabled||(13===(e.keyCode||e.which)?(e.preventDefault(),!1):void 0)})),this.fields.version.on("change",(function(){i.fields.siteKey.val(""),i.fields.secretKey.val(""),i.fields.keysStatus.val("0")})),this.fields.type.on("change",(function(){i.fields.siteKey.val(""),i.fields.secretKey.val(""),i.fields.keysStatus.val("0")}))},disableSubmit:function(){this.fields.save.prop("disabled",!0),this.formDisabled=!0},enableSubmit:function(){this.fields.save.prop("disabled",!1),this.formDisabled=!1},verifyGen:function(){var t={fields:null,cache:null,token:null,string:null,isFirstLoad:!0,scriptId:"amem-recaptcha-api-script",init:function(){this.cleanup(),this.addEventListeners()},cleanup:function(){if(e("#"+this.scriptId).remove(),e(".grecaptcha-badge").remove(),window.grecaptcha)try{delete window.grecaptcha}catch(e){window.grecaptcha=void 0}i.currentSiteKey=null,this.isLoading=!1,this.loadPromise=null},loadApi:function(t){return this.isFirstLoad||i.currentSiteKey!==t||this.isLoading?(this.isFirstLoad=!1,this.isLoading?this.loadPromise.then((()=>this.loadApi(t))):(this.isLoading=!0,this.cleanup(),i.currentSiteKey=t,renderKey="v2"==i.fields.version.val()?"explicit":t,this.loadPromise=new Promise(((t,s)=>{e.ajax({url:`https://www.google.com/recaptcha/api.js?render=${renderKey}`,dataType:"script",cache:!0,scriptAttrs:{id:this.scriptId,async:!0,defer:!0}}).done((()=>{if(this.isLoading=!1,"undefined"==typeof grecaptcha||"function"!=typeof grecaptcha.ready)return this.cleanup(),void s(i.strings.no_recaptcha);grecaptcha.ready((()=>{t()}))})).fail(((e,i)=>{this.isLoading=!1,this.cleanup(),s(`${amemReCaptchaAdmin.api_load_failed} ${i}.`)}))})),this.loadPromise)):Promise.resolve()},addEventListeners:function(){i.fields.siteKey.$el.find("input").on("keyup change",(function(s){i.currentSiteKey!=e(this).val().trim()?t.validateKeys(s):i.currentValidated>"0"?(t.reset(i.fields.keysStatus),t.reset(i.fields.siteKey)):t.setInvalid(i.fields.keysStatus,i.strings.needs_validation)})),i.fields.secretKey.$el.find("input").on("keyup change",(function(s){i.currentSecretKey!=e(this).val().trim()?(i.currentSecretKey=e(this).val().trim(),t.validateKeys(s)):i.currentValidated>"0"?(t.reset(i.fields.keysStatus),t.reset(i.fields.secretKey)):t.setInvalid(i.fields.keysStatus,i.strings.needs_validation)}))},validateKeys:function(s){i.disableSubmit(),i.timer&&(clearTimeout(i.timer),i.xhr&&"function"==typeof i.xhr.abort&&(i.xhr.abort(),i.xhr=null)),t.resetAll(),i.afterValidation();var a=e(s.currentTarget);if(!a.val().trim().length)return field=a.attr("id").indexOf("site_key")>0?i.fields.siteKey:i.fields.secretKey,i.fields.keysStatus.val("0"),t.setInvalid(field,i.strings.empty_key),t.setInvalid(i.fields.keysStatus,i.strings.needs_validation),i.afterValidation(),void i.enableSubmit();i.timer=setTimeout((()=>{t.doValidateKeys(a)}),i.delay)},getRecaptchaToken:function(){return new Promise((function(s,a){try{var n=i.fields.siteKey.val().trim(),r=i.fields.version.val(),l="v2"==r?i.fields.type.val():null;if(0===n.length)return void i.fields.keysStatus.val("0");t.loadApi(n).then((()=>{grecaptcha.ready((function(){try{"v2"==r?(void 0!==t.widgetId&&(grecaptcha.reset(t.widgetId),e("#"+t.widgetContainerId).remove()),t.widgetContainerId="amem-recaptcha-v2-widget",e("#"+t.widgetContainerId).length||(container=e("<div>").attr("id",t.widgetContainerId)["invisible"!=l?"show":"hide"](),i.fields.keysStatus.$el.append(container)),t.widgetId=grecaptcha.render(t.widgetContainerId,{sitekey:n,size:"invisible"==l?"invisible":i.fields.size.val(),callback:function(e){s(e)},"error-callback":function(){a(i.strings.v2_sitekey_error)}}),"invisible"==l&&grecaptcha.execute(t.widgetId)):"v2"==r?a("v2checkbox"):grecaptcha.execute(n,{action:"homepage"}).then((function(e){s(e)}))}catch(e){console.log(e),a(e)}}))}))}catch(e){a(e)}}))},doValidateKeys:function(s){var a=i.fields.siteKey,n=i.fields.secretKey,r=i.fields.keysStatus;if(i.beforeValidation(),!i.fields.siteKey.val().trim().length)return r.val("0"),t.setInvalid(a,i.strings.empty_key),i.afterValidation(),void i.enableSubmit();t.getRecaptchaToken().then((function(e){a.val().trim()!=i.currentSiteKey&&t.setValid(a),t.token=e})).catch((function(e){null===e?(t.setInvalid(a,i.strings.invalid_request),r.val("0"),t.setInvalid(r,i.strings.needs_validation)):"v2checkbox"===e?(r.val("1"),t.setInvalid(r,i.strings.checkbox_novalidation)):e&&e.message?(t.setInvalid(a,e.message),r.val("0"),t.setInvalid(r,i.strings.needs_validation)):(t.setInvalid(a,String(e)),r.val("0"),t.setInvalid(r,i.strings.needs_validation))})).finally((function(){if(!t.token)return i.afterValidation(),void i.enableSubmit();i.xhr=e.ajax({method:"POST",dataType:"JSON",url:amem_options.ajaxurl,data:{action:"amem/recaptcha/key_verify",nonce:amemReCaptchaAdmin.nonce,token:t.token,site_key:i.fields.siteKey.val(),version:i.fields.version.val(),secret_key:i.fields.secretKey.val()},success:function(e){t.resetAll(),e.success?(t.setValid(n),r.val("1"),t.setValid(r,i.strings.keys_verified)):(t.setInvalid(n,e.data),r.val("0"),t.setInvalid(r,i.strings.needs_validation))},error:function(){console.log("reCAPTCHA server request failed"),i.afterValidation(),i.enableSubmit()},complete:function(){t.token=null,i.afterValidation(),i.enableSubmit()}})}))},reset:function(e){e.$el.find(".acf-notice").remove(),e.removeError()},resetAll:function(){this.reset(i.fields.siteKey),this.reset(i.fields.secretKey)},setValid:function(t,s){this.reset(t),s||(s=i.strings.is_valid_key);var a=e('<span class="acf-notice -success acf-success-message">'+s+"</span>");t.$el.find(".acf-input").prepend(a)},setInvalid:function(e,i){this.reset(e),e.showError(i)}};t.init()},verifyEnt:function(){}},e(document).ready((function(){i.init()}))})();